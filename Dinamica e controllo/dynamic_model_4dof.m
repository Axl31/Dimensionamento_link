function Q2dot =dynamic_model_4dof(tau,Q, Qdot)
q1=Q(1);
q2=Q(2);
q3=Q(3);
q4=Q(4);

dot_q1=Qdot(1);
dot_q2=Qdot(2);
dot_q3=Qdot(3);
dot_q4=Qdot(4);

% va cambiata perchè vanno cambiate le maase dei link, dei motori etc                                                
B =[ (21*cos(q2 + q3 + q4))/8000 + (27*cos(q2 + q3))/1600 + (7*cos(q3 + q4))/2500 + (3*cos(q2))/100 + (9*cos(q3))/500 + (21*cos(q4))/8000 + 92616029139475388416811/2213609288845146193920000, (21*cos(q2 + q3 + q4))/16000 + (27*cos(q2 + q3))/3200 + (7*cos(q3 + q4))/2500 + (3*cos(q2))/200 + (9*cos(q3))/500 + (21*cos(q4))/8000 + 12739552041604737684709/553402322211286548480000, (21*cos(q2 + q3 + q4))/16000 + (27*cos(q2 + q3))/3200 + (7*cos(q3 + q4))/5000 + (9*cos(q3))/1000 + (21*cos(q4))/8000 + 17773899083620995758263/2213609288845146193920000, (21*cos(q2 + q3 + q4))/16000 + (7*cos(q3 + q4))/5000 + (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000;
 (21*cos(q2 + q3 + q4))/16000 + (27*cos(q2 + q3))/3200 + (7*cos(q3 + q4))/2500 + (3*cos(q2))/200 + (9*cos(q3))/500 + (21*cos(q4))/8000 + 12739552041604737684709/553402322211286548480000,                                                                          (7*cos(q3 + q4))/2500 + (9*cos(q3))/500 + (21*cos(q4))/8000 + 27981866085410018785703/1106804644422573096960000,                                      (7*cos(q3 + q4))/5000 + (3*cos(q2))/2500 + (9*cos(q3))/1000 + (21*cos(q4))/8000 + 20264209533571785226423/2213609288845146193920000,                                (7*cos(q3 + q4))/5000 + (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000;
                 (21*cos(q2 + q3 + q4))/16000 + (27*cos(q2 + q3))/3200 + (7*cos(q3 + q4))/5000 + (9*cos(q3))/1000 + (21*cos(q4))/8000 + 17773899083620995758263/2213609288845146193920000,                                                      (7*cos(q3 + q4))/5000 + (3*cos(q2))/2500 + (9*cos(q3))/1000 + (21*cos(q4))/8000 + 20264209533571785226423/2213609288845146193920000,                                                                               (3*cos(q2))/1250 + (21*cos(q4))/8000 + 115612662638965401254453/11068046444225730969600000,                                                        (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000;
                                                               (21*cos(q2 + q3 + q4))/16000 + (7*cos(q3 + q4))/5000 + (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000,                                                                                              (7*cos(q3 + q4))/5000 + (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000,                                                                                                      (21*cos(q4))/16000 + 174014285761993443023/368934881474191032320000,                                                                              89082401589289046199/184467440737095516160000];
                                                  
C =[ - dot_q2*((21*sin(q2 + q3 + q4))/16000 + (27*sin(q2 + q3))/3200 + (3*sin(q2))/200) - dot_q4*((21*sin(q2 + q3 + q4))/16000 + (7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) - dot_q3*((21*sin(q2 + q3 + q4))/16000 + (27*sin(q2 + q3))/3200 + (7*sin(q3 + q4))/5000 + (9*sin(q3))/1000), - dot_q4*((21*sin(q2 + q3 + q4))/16000 + (7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) - dot_q3*((21*sin(q2 + q3 + q4))/16000 + (27*sin(q2 + q3))/3200 + (7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) - (3*(dot_q1 + dot_q2)*(7*sin(q2 + q3 + q4) + 45*sin(q2 + q3) + 80*sin(q2)))/16000, - dot_q4*((21*sin(q2 + q3 + q4))/16000 + (7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) - ((dot_q1 + dot_q2 + dot_q3)*(105*sin(q2 + q3 + q4) + 675*sin(q2 + q3) + 112*sin(q3 + q4) + 720*sin(q3)))/80000, -(7*(15*sin(q2 + q3 + q4) + 16*sin(q3 + q4) + 15*sin(q4))*(dot_q1 + dot_q2 + dot_q3 + dot_q4))/80000;
                                                                                          dot_q1*((21*sin(q2 + q3 + q4))/16000 + (27*sin(q2 + q3))/3200 + (3*sin(q2))/200) - dot_q3*((7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) - dot_q4*((7*sin(q3 + q4))/5000 + (21*sin(q4))/16000),                                                                                                                                                                           - dot_q3*((7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) - dot_q4*((7*sin(q3 + q4))/5000 + (21*sin(q4))/16000),                 - ((dot_q1 + dot_q2)*(7*sin(q3 + q4) + 45*sin(q3)))/5000 - dot_q4*((7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) - dot_q3*((7*sin(q3 + q4))/5000 - (3*sin(q2))/2500 + (9*sin(q3))/1000),                        -(7*(16*sin(q3 + q4) + 15*sin(q4))*(dot_q1 + dot_q2 + dot_q3 + dot_q4))/80000;
                                                                                           dot_q1*((21*sin(q2 + q3 + q4))/16000 + (27*sin(q2 + q3))/3200 + (7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) + dot_q2*((7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) - (21*dot_q4*sin(q4))/16000,                                                                                                      dot_q1*((7*sin(q3 + q4))/5000 + (9*sin(q3))/1000) - (3*dot_q3*sin(q2))/2500 - (21*dot_q4*sin(q4))/16000 + dot_q2*((7*sin(q3 + q4))/5000 - (3*sin(q2))/2500 + (9*sin(q3))/1000),                                                                                                                                                 - (3*dot_q2*sin(q2))/2500 - (21*dot_q4*sin(q4))/16000,                                              -(21*sin(q4)*(dot_q1 + dot_q2 + dot_q3 + dot_q4))/16000;
                                                                                                                dot_q1*((21*sin(q2 + q3 + q4))/16000 + (7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) + dot_q2*((7*sin(q3 + q4))/5000 + (21*sin(q4))/16000) + (21*dot_q3*sin(q4))/16000,                                                                                                                                                                                              (7*(dot_q1 + dot_q2)*(16*sin(q3 + q4) + 15*sin(q4)))/80000 + (21*dot_q3*sin(q4))/16000,                                                                                                                                                         (21*sin(q4)*(dot_q1 + dot_q2 + dot_q3))/16000,                                                                                                    0];
 
G =[0;0;0;0];                         
                  
Fv=eye(4)*1e-1;
                          
% eq. della dinamica diretta                        
Q2dot=inv(B)*(tau-C*Qdot-Fv*sign(Qdot)+G);

end